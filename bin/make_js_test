#!/bin/bash
#ensure that the directory exists where the test file will be created
sourcefile=$1
#search for conf file
cnf=
project=

searchdir=`pwd`
while [ -n "$searchdir" ];do
if [ -f "${searchdir}/jsTestDriver.conf" ];then
	cnf="${searchdir}/jsTestDriver.conf"
    project="${searchdir}"
	break
fi
searchdir="${searchdir%/*}"
done

if [ -z "$cnf" ];then
    echo -n "Could not find jsTestDriver.conf file in or above current dir"
    exit 1
fi

testdir="${cnf%jsTestDriver.conf}tests"
if [ ! -d $testdir ];then
    echo -n "test directory does not exist at $testdir"
    exit 1
fi
class=${sourcefile##*/}
class=${class%.js}
testfile=$testdir/${class}Test.js
#make the path to the sourcefile relative to the project dir
relsource=${sourcefile#$project/}
#figure out the package 
package=${relsource%/$class.js}
package=${package#lib/}
package=`echo $package | sed 's:/:.:g'`
# create testfile if it does not exist
if [ ! -f $testfile ];then
	cat $VIM4JS_HOME/templates/jstest.js | sed 's/CLASSNAME/'"$class"'/g' | sed 's/PACKAGE/'"$package"'/g' > $testfile 
fi
#add line to jsTestDriver.conf if it does not exist
if grep -q $relsource $cnf; then
    #nothing
    echo -n ""
else
cat $cnf | sed '/- tests\/*/ i\
\  '"- $relsource"'
' > tmp_cnf
mv tmp_cnf $cnf
fi

echo -n "$testfile"

